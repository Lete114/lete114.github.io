<!DOCTYPE html><head><script src="/sw-action.js?v=0eb5c51aef"></script><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover"><title>使用Service Worker优选请求资源 | Lete乐特 's Blog</title><link rel="shortcut icon" href="https://www.imlete.cn/img/favicon.ico"><meta name="description" content="前言当你的网站或博客有多个部署点时，部署在某个平台的访问速度比较快，于是你就把你的域名解析到了这个平台上，但有时候还是会变得很慢，这时其它站点速度可能会变得比你当前使用的还快一点，难道还有来回解析域名吗？太麻烦了 有没有可以直接返回最快网站资源的办法呢？  使用域名管理平台，有些平台可以解析不同网络或地区的站点例如腾讯云可以区分解析国内三大运营商、境内、境外、等一些解析选项(不太好用，还需要自己测"><meta property="og:type" content="article"><meta property="og:title" content="使用Service Worker优选请求资源"><meta property="og:url" content="https://blog.imlete.cn/article/Service-Worker-Preferred-Request-Resource.html"><meta property="og:site_name" content="Lete乐特 's Blog"><meta property="og:description" content="前言当你的网站或博客有多个部署点时，部署在某个平台的访问速度比较快，于是你就把你的域名解析到了这个平台上，但有时候还是会变得很慢，这时其它站点速度可能会变得比你当前使用的还快一点，难道还有来回解析域名吗？太麻烦了 有没有可以直接返回最快网站资源的办法呢？  使用域名管理平台，有些平台可以解析不同网络或地区的站点例如腾讯云可以区分解析国内三大运营商、境内、境外、等一些解析选项(不太好用，还需要自己测"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-03-20T17:54:13.000Z"><meta property="article:modified_time" content="2024-02-19T14:14:46.820Z"><meta property="article:author" content="Lete乐特"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="教程"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/style.css?v=3deedee8b9"><script src="/js/image-preview.js?v=b548620cbe" defer="defer"></script><script src="/js/main.js?v=6ec3e21cfc" defer="defer"></script><script defer="defer" src="/js/page-load-progress.js?v=3fed90b79b"></script><script async src="/js/visit-stat.js?v=7f35098145"></script><meta name="generator" content="Hexo 5.4.1"></head><html><body><div class="container"><header class="user-select"><div class="header-container-wrap"><div class="header-container"><style>.logo>*{width:auto;height:4rem;border-radius:50%}</style><a href="/" class="logo"><img data-src="https://www.imlete.cn/img/avatar.png" src="/img/load.gif?v=a79c22516f"></a><nav><div class="search" tabindex="-1"><input class="search-input" placeholder="Search for articles" type="search" maxlength="64"><div class="seach-icon-container"><svg class="search-icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.4008 12.4008C14.744 10.0577 14.744 6.25871 12.4008 3.91556C10.0577 1.57242 6.25871 1.57242 3.91556 3.91556C1.57242 6.25871 1.57242 10.0577 3.91556 12.4008C6.25871 14.744 10.0577 14.744 12.4008 12.4008ZM12.4008 12.4008L15.5828 15.5828" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"/></svg></div><div class="search-history"><div class="search-history-title"><span>Search for History</span> <span class="search-history-clear">Clear</span></div><div class="search-history-list"></div></div><div class="search-result"></div><script src="/js/search.js?v=da393275a9" path="/search.json?v=57b66386e0" defer="defer"></script></div></nav></div></div></header><div class="main-wrap"><main class="main-width"><h1 class="page-title">使用Service Worker优选请求资源</h1><article class="article page"><div class="article-info"><img data-src="https://www.imlete.cn/img/avatar.png" alt="avatar" class="avatar" src="/img/load.gif?v=a79c22516f"><div class="article-meta"><div class="author-name">Lete乐特</div><div class="article-meta-list"><time datetime="2022-03-20 17:54:13" title="2022-03-20 17:54:13" class="time">2022-03-20 17:54:13</time><div class="article-meta-item-wrap"><div class="article-meta-item"><svg class="word-icon" width="16" height="16" viewBox="0 0 48 48" fill="none" stroke-width="4" stroke-linejoin="round" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10 4H30L40 14V42C40 43.1046 39.1046 44 38 44H10C8.89543 44 8 43.1046 8 42V6C8 4.89543 8.89543 4 10 4Z"/><path d="M16.0083 20L19.0083 34L24.0083 24L29.0083 34L32.0083 20"/></svg> <span>2.9k</span></div><div class="article-meta-item"><svg class="time-icon" width="16" height="16" viewBox="0 0 48 48" fill="none" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M24 44C35.0457 44 44 35.0457 44 24C44 12.9543 35.0457 4 24 4C12.9543 4 4 12.9543 4 24C4 35.0457 12.9543 44 24 44Z"/><path d="M24.0084 12.0001L24.0072 24.0089L32.4866 32.4883"/></svg> <span>12min</span></div></div></div></div></div><div class="article-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当你的网站或博客有多个部署点时，部署在某个平台的访问速度比较快，于是你就把你的域名解析到了这个平台上，但有时候还是会变得很慢，这时其它站点速度可能会变得比你当前使用的还快一点，难道还有来回解析域名吗？太麻烦了</p><p>有没有可以直接返回最快网站资源的办法呢？</p><ol><li>使用域名管理平台，有些平台可以解析不同网络或地区的站点<br>例如<strong>腾讯云</strong>可以区分解析国内三大运营商、境内、境外、等一些解析选项(不太好用，还需要自己测试，难不成求使用其它运营商手机的朋友帮你测一下快不快嘛~)</li><li>使用 js 拦截网站的所有请求，并篡改将请求发送到自己的所有站点，这些站点中如果哪个站点最快返回，那么就用最快返回的这个信息，与此同时将其它的请求全部切断</li></ol><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>本文会详细说明如何<strong>使用 Service Worker 优选请求资源</strong>让你的网站比以前更快，更稳定</p><p><strong>Service Worker</strong>在接下来的内容中统一称呼为<strong>sw</strong></p><h3 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h3><blockquote><p>更详细请看<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API</a></p></blockquote><p>Service workers 本质上充当 Web 应用程序、浏览器与网络（可用时）之间的代理服务器</p><p>Service worker 运行在 worker 上下文，因此它不能访问 DOM。相对于驱动应用的主 JavaScript 线程，它运行在其他线程中，所以不会造成阻塞。</p><p>出于安全考量，Service workers 只能由 HTTPS 承载，毕竟修改网络请求的能力暴露给中间人攻击会非常危险。</p><h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p>注册 sw 很简单，只需一行代码即可，如果注册成功，则 sw 会被下载到客户端并且安装和激活，这一步仅仅是注册而已，完整的是: 下载—&gt;安装—&gt;激活</p><blockquote><p>注意: sw 的注册日志记录在 Chrome 浏览器中可以通过访问<a href="chrome://serviceworker-internals">chrome://serviceworker-internals</a>查看</p></blockquote><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">'/Service-Worker.js'</span>)</span><br></pre></td></tr></table></figure><p>其中<code>/Service-Worker.js</code>必须是当前域下的 js 文件，他不能是其它域下的，即使 js 文件内的内容完全相等，那也不行</p><p>如果你只想在某个路径写使用 sw 的话，你可以使用<code>scope</code>选项，当然<code>/Service-Worker.js</code>的位置也可以自定义(只要是同源且是 https 协议就可以)，如下只有在<code>/article/</code>文章页 sw 才启动，其它路径写 sw 不进行处理</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">'/sw-test/Service-Worker.js'</span>, { <span class="attr">scope</span>: <span class="string">'/article/'</span> })</span><br></pre></td></tr></table></figure><p>并且必须是 https 协议，如果是本地<code>127.0.0.1</code>或<code>localhost</code>是被允许的</p><p>这是一个完整的注册代码</p><p>将安装代码放置在<code>&lt;head&gt;</code>之后</p><figure class="highlight html">
    <div class="code-block-header" lang="html">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  ;(<span class="keyword">function</span> (<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (navigator.<span class="property">serviceWorker</span>) {</span></span><br><span class="line"><span class="language-javascript">      navigator.<span class="property">serviceWorker</span></span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">register</span>(<span class="string">'/sw.js'</span>)</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 判断是否安装了sw</span></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">'installSW'</span>)) <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">'installSW'</span>, <span class="literal">true</span>)</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 这里就不用清理setInterval了，因为页面刷新后就没有了</span></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 判断sw安装后，是否处于激活状态，激活后刷新页面</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (result.<span class="property">active</span>.<span class="property">state</span> === <span class="string">'activated'</span>) {</span></span><br><span class="line"><span class="language-javascript">              <span class="built_in">clearInterval</span>(timer)</span></span><br><span class="line"><span class="language-javascript">              <span class="title function_">fetch</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">text</span>())</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function">(<span class="params">text</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">document</span>.<span class="title function_">open</span>()</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">document</span>.<span class="title function_">write</span>(text)</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">document</span>.<span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">                })</span></span><br><span class="line"><span class="language-javascript">            }</span></span><br><span class="line"><span class="language-javascript">          }, <span class="number">100</span>)</span></span><br><span class="line"><span class="language-javascript">        })</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  })()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><h3 id="installing-状态"><a href="#installing-状态" class="headerlink" title="installing 状态"></a>installing 状态</h3><p>当注册成功后会触发<strong>install</strong>事件，然后触发<strong>activate</strong>事件，此时如果再次刷新页面，它俩都不会被触发了</p><p>直到<code>/sw.js</code>发生了改变，它就会触发一次 <strong>install</strong> (不仅仅是代码改变，哪怕是多一个空格或是少一个空格，又或是写一个注释都会被触发)，但是只执行了<strong>install</strong>事件，并没有执行<strong>activate</strong>事件</p><h3 id="activing-状态"><a href="#activing-状态" class="headerlink" title="activing 状态"></a>activing 状态</h3><p>为什么<strong>activate</strong>事件不触发了？因为已经有一个 sw 了，它一种处于等待状态，至于什么时候才会被触发，那就是等之前的 sw 停止了才会触发<strong>activate</strong>事件</p><p>那有没有办法不让它等待呢？答案是: <strong>有</strong></p><p>使用<code>skipWaiting()</code>跳过等待，它返回一个 promise 对象(异步的)，防止还在执行<code>skipWaiting()</code>的时候直接就跳到<strong>activate</strong>事件，我们需要使用<code>async/await</code>，也可以使用<code>event.waitUntil(skipWaiting())</code>方法把<code>skipWaiting()</code>放到里面，和<code>async/await</code>效果一样</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在sw中可以使用this或是self表示自身</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'install'</span>, <span class="keyword">async</span> (event) =&gt; {</span><br><span class="line">  <span class="comment">// event.waitUntil(self.skipWaiting())</span></span><br><span class="line">  <span class="keyword">await</span> self.<span class="title function_">skipWaiting</span>()</span><br><span class="line">})</span><br></pre></td></tr></table></figure><p>触发<strong>activate</strong>事件后 ，当前这一次网页是不会被 sw 管理的，需要下次页面刷新才会被 sw 管理，那怎么让它立即管理页面呢？</p><blockquote><p>更详细请看:<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerGlobalScope/skipWaiting">https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerGlobalScope/skipWaiting</a> &gt; <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Clients/claim">https://developer.mozilla.org/en-US/docs/Web/API/Clients/claim</a></p></blockquote><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'activate'</span>, <span class="keyword">async</span> (event) =&gt; {</span><br><span class="line">  <span class="comment">// event.waitUntil(self.clients.claim())</span></span><br><span class="line">  <span class="keyword">await</span> self.<span class="property">clients</span>.<span class="title function_">claim</span>() <span class="comment">// 立即管理页面</span></span><br><span class="line">})</span><br></pre></td></tr></table></figure><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>详细上面生命周期已经详细说明了</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'install'</span>, <span class="keyword">async</span> (event) =&gt; {</span><br><span class="line">  <span class="comment">// event.waitUntil(self.skipWaiting())</span></span><br><span class="line">  <span class="keyword">await</span> self.<span class="title function_">skipWaiting</span>()</span><br><span class="line">})</span><br></pre></td></tr></table></figure><h2 id="捕获请求"><a href="#捕获请求" class="headerlink" title="捕获请求"></a>捕获请求</h2><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'fetch'</span>, <span class="keyword">async</span> (event) =&gt; {</span><br><span class="line">  <span class="comment">// 所有请求都得转到 handleRequest 函数内处理</span></span><br><span class="line">  <span class="title function_">handleRequest</span>(event.<span class="property">request</span>)</span><br><span class="line">    <span class="comment">// 如果 handleRequest 请求成功则将数据响应到网页</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> event.<span class="title function_">respondWith</span>(result))</span><br><span class="line">    <span class="comment">// 如果 handleRequest 请求失败，什么都不做(这是网页自己走自己的实际请求)</span></span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> <span class="number">0</span>)</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">req</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(req.<span class="property">url</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p><code>event.respondWith()</code>: 给浏览器一个响应，因为我们已经使用<code>Fetch API</code>替浏览器发送了请求，并且得到了结果并且返回，那么自然是要返回给浏览器啦</p><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API">Fetch API</a>可以和<code>XMLHttpRequest</code>一样，可以发送任何请求</p><blockquote><p>值得一提的是使用 Fetch API 发送请求是会存在跨域问题的，一旦被跨域拦截，那么就上面都没有返回，会导致页面显示不了请求的内容(例如图片被跨域拦截了)，而 img、script 标签它们是不会发生跨域请求问题的，所以上面 catch 捕获异常一个 0 和 null 差不多<br>既然没有用到 event.respondWith 那自然是没有给浏览器返回数据啦，那浏览器就自己请求(很好的避免了这个问题)</p></blockquote><h2 id="篡改请求"><a href="#篡改请求" class="headerlink" title="篡改请求"></a>篡改请求</h2><p>上面我们都可以使用<code>Fetch API</code>替浏览器发送请求了，那是不是可以篡改呢？</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">req</span>) {</span><br><span class="line">  <span class="comment">// 仅仅只是举个例子，更多奇妙的用法等待你去探索</span></span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">'https://cdn.jsdelivr.net/npm/xhr-ajax/dist/'</span></span><br><span class="line">  <span class="keyword">const</span> url = req.<span class="property">url</span>.<span class="title function_">replace</span>(str + <span class="string">'ajax.js'</span>, str + <span class="string">'ajax.min.js'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>如上代码，我们就可以将 ajax 请求的第三方库 js 文件请求变为压缩后的请求，并返回给浏览器(篡改成功)</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">req</span>) {</span><br><span class="line">  <span class="comment">// 可以是多个</span></span><br><span class="line">  <span class="keyword">const</span> urls = [</span><br><span class="line">    <span class="string">"https://cdn.jsdelivr.net/npm/xhr-ajax/dist/ajax.min.js"</span>,</span><br><span class="line">    <span class="string">"https://unpkg.com/xhr-ajax/dist/ajax.min.js"</span>,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// 中断一个或多个请求</span></span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">  <span class="comment">// 可以中断请求</span></span><br><span class="line">  <span class="comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController#%E5%B1%9E%E6%80%A7</span></span><br><span class="line">  <span class="keyword">const</span> signal = controller.<span class="property">signal</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历将所有的请求地址转换为promise</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">PromiseAll</span> = urls.<span class="title function_">map</span>(<span class="function">(<span class="params">url</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; {</span><br><span class="line">      <span class="title function_">fetch</span>(url, { signal })</span><br><span class="line">        .<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> res.<span class="title function_">arrayBuffer</span>(), {</span><br><span class="line">              <span class="attr">status</span>: res.<span class="property">status</span>,</span><br><span class="line">              <span class="attr">headers</span>: res.<span class="property">headers</span>,</span><br><span class="line">            })</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">          <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) <span class="title function_">reject</span>(<span class="literal">null</span>);</span><br><span class="line">          <span class="comment">// 只要有一个请求成功返回那么就把所有的请求断开</span></span><br><span class="line">          controller.<span class="title function_">abort</span>(); <span class="comment">// 中断</span></span><br><span class="line">          <span class="title function_">resolve</span>(res);</span><br><span class="line">        })</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="literal">null</span>));</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">  <span class="comment">// 使用 Promise.any 发送批量请求，它接收一个可迭代对象，例如数组就是一个可迭代对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">any</span>(<span class="title class_">PromiseAll</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> <span class="literal">null</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure><blockquote><p>Promise.any 具体请看: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/any">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/any</a><br>AbortController 具体请看: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController">https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController</a></p></blockquote><p>只要传入的迭代对象中的任何一个 <code>promise</code> 返回成功（resolve）状态，那么它就返回成功状态，如果其中的所有的 <code>promises</code> 都失败，那么就会把所有的失败返回</p><p>所以只要<code>Promise.any</code>有一个成功状态的数据返回，那么我们就把这个数据响应给浏览器，而其它 的请求全部切断，这样就可以高效的在不同地区响应最快的资源给用户啦~</p><p>这也是正文开始前我们所需要解决的问题</p><h2 id="完整-sw-js-文件"><a href="#完整-sw-js-文件" class="headerlink" title="完整 sw.js 文件"></a>完整 sw.js 文件</h2><p>这是我总结写出的一个 sw.js 文件，你只需要将下面的<code>origin</code>数组改成你的博客地址就可以了，其它的可以不用动，如果你想添加新东西，那就随便你啦~哈哈哈</p><figure class="highlight js">
    <div class="code-block-header" lang="js">
      <span class="copy-code">COPY</span>
    </div>
    <table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> origin = [<span class="string">'https://blog.imlete.cn'</span>, <span class="string">'https://lete114.github.io'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cdn = {</span><br><span class="line">  <span class="attr">gh</span>: {</span><br><span class="line">    <span class="attr">jsdelivr</span>: <span class="string">'https://cdn.jsdelivr.net/gh'</span>,</span><br><span class="line">    <span class="attr">fastly</span>: <span class="string">'https://fastly.jsdelivr.net/gh'</span>,</span><br><span class="line">    <span class="attr">gcore</span>: <span class="string">'https://gcore.jsdelivr.net/gh'</span>,</span><br><span class="line">    <span class="attr">testingcf</span>: <span class="string">'https://testingcf.jsdelivr.net/gh'</span>,</span><br><span class="line">    <span class="attr">test1</span>: <span class="string">'https://test1.jsdelivr.net/gh'</span>,</span><br><span class="line">    <span class="attr">tianli</span>: <span class="string">'https://cdn1.tianli0.top/gh'</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">combine</span>: {</span><br><span class="line">    <span class="attr">jsdelivr</span>: <span class="string">'https://cdn.jsdelivr.net/combine'</span>,</span><br><span class="line">    <span class="attr">fastly</span>: <span class="string">'https://fastly.jsdelivr.net/combine'</span>,</span><br><span class="line">    <span class="attr">gcore</span>: <span class="string">'https://gcore.jsdelivr.net/combine'</span>,</span><br><span class="line">    <span class="attr">testingcf</span>: <span class="string">'https://testingcf.jsdelivr.net/combine'</span>,</span><br><span class="line">    <span class="attr">test1</span>: <span class="string">'https://test1.jsdelivr.net/combine'</span>,</span><br><span class="line">    <span class="attr">tianli</span>: <span class="string">'https://cdn1.tianli0.top/combine'</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">npm</span>: {</span><br><span class="line">    <span class="attr">jsdelivr</span>: <span class="string">'https://cdn.jsdelivr.net/npm'</span>,</span><br><span class="line">    <span class="attr">fastly</span>: <span class="string">'https://fastly.jsdelivr.net/npm'</span>,</span><br><span class="line">    <span class="attr">gcore</span>: <span class="string">'https://gcore.jsdelivr.net/npm'</span>,</span><br><span class="line">    <span class="attr">testingcf</span>: <span class="string">'https://testingcf.jsdelivr.net/npm'</span>,</span><br><span class="line">    <span class="attr">test1</span>: <span class="string">'https://test1.jsdelivr.net/npm'</span>,</span><br><span class="line">    <span class="attr">unpkg</span>: <span class="string">'https://unpkg.com'</span>,</span><br><span class="line">    <span class="attr">tianli</span>: <span class="string">'https://cdn1.tianli0.top/npm'</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'install'</span>, <span class="keyword">async</span> () =&gt; {</span><br><span class="line">  <span class="keyword">await</span> self.<span class="title function_">skipWaiting</span>()</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'activate'</span>, <span class="keyword">async</span> () =&gt; {</span><br><span class="line">  <span class="keyword">await</span> self.<span class="property">clients</span>.<span class="title function_">claim</span>()</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">'fetch'</span>, <span class="keyword">async</span> (event) =&gt; {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    event.<span class="title function_">respondWith</span>(<span class="title function_">handleRequest</span>(event.<span class="property">request</span>))</span><br><span class="line">  } <span class="keyword">catch</span> (e) {}</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回响应</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">progress</span>(<span class="params">res</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> res.<span class="title function_">arrayBuffer</span>(), {</span><br><span class="line">    <span class="attr">status</span>: res.<span class="property">status</span>,</span><br><span class="line">    <span class="attr">headers</span>: res.<span class="property">headers</span></span><br><span class="line">  })</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">req</span>) {</span><br><span class="line">  <span class="keyword">const</span> urls = []</span><br><span class="line">  <span class="keyword">const</span> urlStr = req.<span class="property">url</span></span><br><span class="line">  <span class="keyword">let</span> urlObj = <span class="keyword">new</span> <span class="title function_">URL</span>(urlStr)</span><br><span class="line">  <span class="comment">// 为了获取 cdn 类型</span></span><br><span class="line">  <span class="comment">// 例如获取gh (https://cdn.jsdelivr.net/gh)</span></span><br><span class="line">  <span class="keyword">const</span> path = urlObj.<span class="property">pathname</span>.<span class="title function_">split</span>(<span class="string">'/'</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 匹配 cdn</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> type <span class="keyword">in</span> cdn) {</span><br><span class="line">    <span class="keyword">if</span> (type === path) {</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> cdn[type]) {</span><br><span class="line">        <span class="keyword">const</span> url = cdn[type][key] + urlObj.<span class="property">pathname</span>.<span class="title function_">replace</span>(<span class="string">'/'</span> + path, <span class="string">''</span>)</span><br><span class="line">        urls.<span class="title function_">push</span>(url)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果上方 cdn 遍历 匹配到 cdn 则直接统一发送请求(不会往下执行了)</span></span><br><span class="line">  <span class="keyword">if</span> (urls.<span class="property">length</span>) <span class="keyword">return</span> <span class="title function_">fetchAny</span>(urls)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将用户访问的当前网站与所有源站合并</span></span><br><span class="line">  <span class="keyword">let</span> origins = [...<span class="keyword">new</span> <span class="title class_">Set</span>([location.<span class="property">origin</span>, ...origin])]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历判断当前请求是否是源站主机</span></span><br><span class="line">  <span class="keyword">const</span> is = origins.<span class="title function_">find</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="keyword">new</span> <span class="title function_">URL</span>(urlStr).<span class="property">hostname</span> === <span class="keyword">new</span> <span class="title function_">URL</span>(i).<span class="property">hostname</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是源站，则竞速获取(不会往下执行了)</span></span><br><span class="line">  <span class="keyword">if</span> (is) {</span><br><span class="line">    origins = origins.<span class="title function_">map</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> i + urlObj.<span class="property">pathname</span> + urlObj.<span class="property">search</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetchAny</span>(origins)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 抛出异常是为了让sw不拦截请求</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'不是源站'</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise.any 的 polyfill</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPromiseAny</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="property">any</span> = <span class="keyword">function</span> (<span class="params">promises</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">      promises = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(promises) ? promises : []</span><br><span class="line">      <span class="keyword">let</span> len = promises.<span class="property">length</span></span><br><span class="line">      <span class="keyword">let</span> errs = []</span><br><span class="line">      <span class="keyword">if</span> (len === <span class="number">0</span>) <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AggregateError</span>(<span class="string">'All promises were rejected'</span>))</span><br><span class="line">      promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!p <span class="keyword">instanceof</span> <span class="title class_">Promise</span>) <span class="keyword">return</span> <span class="title function_">reject</span>(p)</span><br><span class="line">        p.<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">res</span>) =&gt;</span> <span class="title function_">resolve</span>(res),</span><br><span class="line">          <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">            len--</span><br><span class="line">            errs.<span class="title function_">push</span>(err)</span><br><span class="line">            <span class="keyword">if</span> (len === <span class="number">0</span>) <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AggregateError</span>(errs))</span><br><span class="line">          }</span><br><span class="line">        )</span><br><span class="line">      })</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送所有请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchAny</span>(<span class="params">urls</span>) {</span><br><span class="line">  <span class="comment">// 中断一个或多个请求</span></span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>()</span><br><span class="line">  <span class="keyword">const</span> signal = controller.<span class="property">signal</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历将所有的请求地址转换为promise</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">PromiseAll</span> = urls.<span class="title function_">map</span>(<span class="function">(<span class="params">url</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">      <span class="title function_">fetch</span>(url, { signal })</span><br><span class="line">        .<span class="title function_">then</span>(progress)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">          <span class="keyword">const</span> r = res.<span class="title function_">clone</span>()</span><br><span class="line">          <span class="keyword">if</span> (r.<span class="property">status</span> !== <span class="number">200</span>) <span class="title function_">reject</span>(<span class="literal">null</span>)</span><br><span class="line">          controller.<span class="title function_">abort</span>() <span class="comment">// 中断</span></span><br><span class="line">          <span class="title function_">resolve</span>(r)</span><br><span class="line">        })</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="literal">null</span>))</span><br><span class="line">    })</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断浏览器是否支持 Promise.any</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Promise</span>.<span class="property">any</span>) <span class="title function_">createPromiseAny</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 谁先返回"成功状态"则返回谁的内容，如果都返回"失败状态"则返回null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">any</span>(<span class="title class_">PromiseAll</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> <span class="literal">null</span>)</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="article-end"><div class="article-meta"><div class="article-tags"><div class="article-tags-name">Tags:</div><a class="article-tags-item" href="/tags/JavaScript/">JavaScript </a><a class="article-tags-item" href="/tags/%E6%95%99%E7%A8%8B/">教程</a></div></div><div class="post-copyright"><div class="post-copyright-icon"><svg class="copyright-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm117.134 346.753c-1.592 1.867-39.776 45.731-109.851 45.731-84.692 0-144.484-63.26-144.484-145.567 0-81.303 62.004-143.401 143.762-143.401 66.957 0 101.965 37.315 103.422 38.904a12 12 0 0 1 1.238 14.623l-22.38 34.655c-4.049 6.267-12.774 7.351-18.234 2.295-.233-.214-26.529-23.88-61.88-23.88-46.116 0-73.916 33.575-73.916 76.082 0 39.602 25.514 79.692 74.277 79.692 38.697 0 65.28-28.338 65.544-28.625 5.132-5.565 14.059-5.033 18.508 1.053l24.547 33.572a12.001 12.001 0 0 1-.553 14.866z"/></svg></div><div class="post-copyright-author"><span class="post-copyright-meta">Authorship: </span><span class="post-copyright-info"><a href="https://blog.imlete.cn">Lete乐特</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">Article Link: </span><span class="post-copyright-info"><a href="https://blog.imlete.cn/article/Service-Worker-Preferred-Request-Resource.html">https://blog.imlete.cn/article/Service-Worker-Preferred-Request-Resource.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">Copyright: </span><span class="post-copyright-info">All posts on this blog are licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> license unless otherwise stated. Please cite <a href="https://blog.imlete.cn" target="_blank">Lete乐特 's Blog</a> !</span></div></div></div></article></main><aside tabindex="-1"><div class="sidebar-block sidebar-sticky toc-wrap" tabindex="-1"><div class="toc-btn"><svg class="toc-btn-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z"/><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z"/></svg></div><div class="sidebar-title toc-title">Catalog</div><div class="sidebar-body"><ul class="toc-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-Worker"><span class="toc-number">2.1.</span> <span class="toc-text">Service Worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C"><span class="toc-number">2.2.</span> <span class="toc-text">注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">3.</span> <span class="toc-text">生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#installing-%E7%8A%B6%E6%80%81"><span class="toc-number">3.1.</span> <span class="toc-text">installing 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#activing-%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.</span> <span class="toc-text">activing 状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E8%AF%B7%E6%B1%82"><span class="toc-number">5.</span> <span class="toc-text">捕获请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AF%A1%E6%94%B9%E8%AF%B7%E6%B1%82"><span class="toc-number">6.</span> <span class="toc-text">篡改请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4-sw-js-%E6%96%87%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">完整 sw.js 文件</span></a></li></ol></ul></div></div></aside></div><footer class="footer main-width"><div class="copyright">© 2020 - 2024 Lete乐特</div><div class="framework-info"><span>Framework</span> <a href="https://hexo.io" target="_blank">Hexo</a> <span class="footer-separator">|</span> <span>Theme</span> <a href="https://github.com/Lete114/hexo-theme-MengD" target="_blank">MengD</a></div><div class="custom">我相信我可以，但我一直在路上，所以我有无限的可能！！</div></footer></div></body></html>